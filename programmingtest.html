<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Programming Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
    }
    header {
      background-color: #343a40;
      color: white;
      padding: 20px;
      text-align: center;
    }
    .container {
      max-width: 900px;
      margin: 30px auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .question-block {
      margin-bottom: 50px;
      padding-bottom: 30px;
      border-bottom: 1px solid #ccc;
    }
    pre {
      background-color: #f1f1f1;
      padding: 10px;
      border-radius: 6px;
      font-family: monospace;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
<header>Programming Prediction Test</header>

<div class="container">
  <form id="programmingTestForm">
    <div id="questionContainer"></div>
    <button type="submit" class="btn btn-dark">Submit Test</button>
  </form>
</div>

<script>
let userAnswers = {};

async function loadProgrammingQuestions() {
  const res = await fetch("/api/get_programming_questions");
  const data = await res.json();
  if (!data.success) return alert("❌ Failed to load questions");

  const container = document.getElementById("questionContainer");

  data.questions.forEach((q, index) => {
    const id = q._id.$oid || q._id;
    const block = document.createElement("div");
    block.className = "question-block";

    block.innerHTML = `
      <h5>Q${index + 1}: ${q.question}</h5>
      <p><strong>Code:</strong></p>
      <pre>${q.codeSnippet || "// No code snippet provided"}</pre>
      <label for="answer_${id}">Your Predicted Output:</label>
      <textarea id="answer_${id}" rows="3" class="form-control mb-3" placeholder="Type the expected output here..."></textarea>
    `;

    container.appendChild(block);
  });
}
async function submitTest(event) {
  event.preventDefault();

  const email = localStorage.getItem("userEmail");
  if (!email) return alert("Missing email");

  const answers = {};
  document.querySelectorAll("textarea[id^='answer_']").forEach(textarea => {
    const id = textarea.id.replace("answer_", "");
    const value = textarea.value.trim();
    if (value) {
      answers[`answer_${id}`] = value;
    }
  });

  if (Object.keys(answers).length === 0) {
    return alert("❌ Please answer at least one question before submitting.");
  }

  const payload = { email, answers };

  // 1. Submit the test
  const res = await fetch("/submit_programming_test", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const result = await res.json();
  if (!result.success) return alert("❌ Submission failed.");

  // 2. Save score to user document
  const scorePayload = {
    email,
    score: result.score ?? 0,
    percentage: result.percentage ?? 0,
    type1: "Programming Test Score",
    type2: "Programming Percentage"
  };

  await fetch("/save_score", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(scorePayload)
  });

  // 3. Redirect to results
  localStorage.setItem("testType", "programming");
  window.location.href = "/results";
}


document.getElementById("programmingTestForm").addEventListener("submit", submitTest);
window.onload = loadProgrammingQuestions;
</script>
</body>
</html>
